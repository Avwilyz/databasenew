<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NdikaFath X Databases</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet" />
  <style>
    :root {
      --primary: #4361ee;
      --success: #10b981;
      --gray: #64748b;
      --gray-light: #e2e8f0;
      --light: #f8fafc;
      --dark: #1e293b;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Poppins', sans-serif;
      background: #f1f5f9;
      color: var(--dark);
      display: flex; justify-content: center; align-items: center;
      min-height: 100vh; padding: 1rem;
    }
    .container {
      background: #fff;
      border-radius: 1rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      width: 100%; max-width: 800px; padding: 2rem;
    }
    .logo { display: flex; justify-content: center; align-items: center; gap: .75rem; margin-bottom: .5rem; }
    .logo i { color: var(--primary); font-size: 1.7rem; }
    .logo-text { font-size: 1.5rem; font-weight: 600; }
    .page-description { text-align: center; color: var(--gray); margin-bottom: 1.5rem; }

    /* Form input */
    form {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    input, button {
      padding: .8rem 1rem;
      border-radius: .5rem;
      font-size: 1rem;
      border: 1px solid var(--gray-light);
      flex: 1;
      min-width: 220px;
      transition: all 0.2s ease;
    }
    input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(67,97,238,0.2); }
    button {
      background: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 500;
      flex: 0 0 auto;
    }
    button:hover { background: #3a56d4; }
    @media (max-width: 600px) {
      form { flex-direction: column; }
      input, button { width: 100%; }
    }

    .search-box { position: relative; margin: 1rem 0; }
    .search-box input { width: 100%; padding-left: 2.5rem; }
    .search-icon {
      position: absolute; top: 50%; left: 1rem; transform: translateY(-50%);
      color: var(--gray);
    }

    table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: .95rem; }
    th, td { padding: .75rem; text-align: center; border-bottom: 1px solid var(--gray-light); }
    th { background: #e0e7ff; color: var(--primary); }
    .status { display: inline-block; padding: .25rem .75rem; border-radius: 1rem; font-size: .85rem; font-weight: 500; }
    .status-active { background: #d1fae5; color: var(--success); }

    .footer { text-align: center; margin-top: 1.5rem; }
    .footer a { color: var(--primary); text-decoration: none; font-weight: 500; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <i class="fas fa-database"></i>
        <div class="logo-text">NdikaFath X Databases</div>
      </div>
      <p class="page-description">Add and check your registered numbers</p>
    </header>

    <form id="addForm">
      <input id="number" type="text" placeholder="Enter phone number" required />
      <button type="submit"><i class="fas fa-plus"></i> Add Number</button>
    </form>

    <div class="search-box">
      <i class="fas fa-search search-icon"></i>
      <input type="text" id="searchInput" placeholder="Search numbers..." onkeyup="filterTable()" />
    </div>

    <div class="table-responsive">
      <table id="numberTable">
        <thead><tr><th>Number</th><th>Status</th></tr></thead>
        <tbody id="numberBody"><tr><td colspan="2">Loading...</td></tr></tbody>
      </table>
    </div>

    <footer class="footer">
      <a href="https://wa.me/62895428689834" target="_blank">
        <i class="fab fa-whatsapp"></i> Contact Support
      </a>
    </footer>
  </div>

  <script>
    const GET_URL = "/api/functions/getNumbers";
    const ADD_URL = "/api/functions/addNumber";
    const tbody = document.getElementById("numberBody");
    const form = document.getElementById("addForm");
    let numbers = []; // simpan data lokal

    async function loadNumbers() {
      tbody.innerHTML = `<tr><td colspan="2">Loading...</td></tr>`;
      try {
        const res = await fetch(GET_URL, { cache: "no-store" });
        numbers = await res.json();
        renderTable(numbers);
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="2" style="color:red;">Failed to load data</td></tr>`;
      }
    }

    function renderTable(data) {
      if (!Array.isArray(data) || data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="2">No data found</td></tr>`;
        return;
      }
      tbody.innerHTML = data.map(d => `
        <tr>
          <td>${d.number}</td>
          <td><span class="status status-active">active</span></td>
        </tr>
      `).join("");
    }

    function filterTable() {
      const filter = document.getElementById("searchInput").value.toLowerCase();
      Array.from(tbody.getElementsByTagName("tr")).forEach(row => {
        const num = row.cells[0]?.textContent.toLowerCase() || "";
        row.style.display = num.includes(filter) ? "" : "none";
      });
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const input = document.getElementById("number");
      const number = input.value.replace(/[^\d]/g, ""); // hapus + dan simbol
      if (number.length < 6) return alert("Nomor tidak valid");

      // waktu otomatis WIB
      const now = new Date();
      const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
      const gmt7 = new Date(utc + (7 * 60 * 60000));
      const hari = gmt7.toLocaleString("id-ID", { weekday: "long" });
      const tanggal = gmt7.getDate();
      const bulan = gmt7.toLocaleString("id-ID", { month: "long" });
      const tahun = gmt7.getFullYear();
      const jam = String(gmt7.getHours()).padStart(2, "0");
      const menit = String(gmt7.getMinutes()).padStart(2, "0");
      const detik = String(gmt7.getSeconds()).padStart(2, "0");
      const time = `${hari}, ${tanggal} ${bulan} ${tahun} Pukul ${jam}:${menit}:${detik} WIB`;

      const res = await fetch(ADD_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ number, time }),
      });
      const result = await res.json();

      if (result.success) {
        numbers.push({ number, time });
        renderTable(numbers);
        input.value = "";
      } else {
        alert("❌ Gagal menambah nomor");
      }
    });

    loadNumbers();
  </script>
</body>
</html>
